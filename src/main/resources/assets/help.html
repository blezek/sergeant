<h1 id="sergeant">Sergeant</h1>
<p>Sergeant is a simple <a href="http://dropwizard.github.io/dropwizard/">DropWizard</a> based web application to allow command line programs to be run as web services.  Yes, I know this is dangerous, but so is driving a car.  If one is careful both can be done safely.</p>
<h2 id="installation">Installation</h2>
<h4 id="linux-mac-osx-">Linux / Mac OSX:</h4>
<pre class="editor-colors"><code>git clone https://github.com/dblezek/sergeant.git
cd sergeant
./gradlew run
</code></pre><h4 id="windows">Windows</h4>
<pre class="editor-colors"><code>git clone https://github.com/dblezek/sergeant.git
cd sergeant
gradlew.bat run
</code></pre><p>Open <a href="http://localhost:8080/">http://localhost:8080/</a></p>
<h2 id="usage">Usage</h2>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell">java -jar sergeant.jar server sergeant.yml</span></div></code></pre>
<h2 id="defining-services">Defining services</h2>
<p><strong>Services</strong> are command line interfaces (CLI) exposed through sergeant as REST endpoints.  Services are defined using <a href="http://www.yaml.org/spec/1.2/spec.html">YAML</a> (YAML Ain't Markup Language) in the <strong>sergeant.yml</strong> file, and have several parameters.</p>
<ul>
<li><strong>endPoint</strong>: this is the REST end point that exposes this CLI</li>
<li><strong>description</strong>: a description of the endPoint.  <a href="http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines">Descriptions can span multiple lines.</a></li>
<li><strong>commandLine</strong>: an array of parameters that form the command line.  Any parameter of the form "@variable" will be replaced when sergeant runs the CLI.  See the <strong>sleep</strong> example below.</li>
<li><strong>synchronous</strong>: return results immediately</li>
<li><strong>gridSubmit</strong>: Submit to a grid using <a href="http://www.drmaa.org/">DRMAA</a>, must start up with a drmaa library available in <code>java.library.path</code>.  Ignores the <code>synchronous</code> setting.</li>
<li><strong>gridSpecification</strong>: String to pass through DRMAA into the underlying grid implementation.</li>
<li><strong>defaults</strong>: a map of default values for any variables in the command line.  This parameter is optional, and variables do not need defaults.</li>
</ul>
<h3 id="synchronous-services">Synchronous services</h3>
<p>Synchronous services return the output immediately.</p>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell">curl -POST -d <span class="string quoted double shell"><span class="punctuation definition string begin shell">"</span>text=Something going on here<span class="punctuation definition string end shell">"</span></span> http://localhost:8080/rest/service/echo</span></div><div><span class="source shell">Something going on here</span></div></code></pre>
<h3 id="asynchronous-services">Asynchronous services</h3>
<p>By default, services return a uuid that can be used to retrieve results after processing has finished.</p>
<h3 id="service-environment">Service Environment</h3>
<p>Sergeant includes a <code>sergeantw</code> a wrapper for sergeant services.  <code>sergeantw</code> looks for a <code>sergeant-env.sh</code> and sources it to configure a particular environment to run the CLI.  This is particularly helpful, as sargeant is often run as a daemon with a severely limited environment.</p>
<h3 id="reloading-services">Reloading Services</h3>
<p>Services definitions are reloaded at a frequency specified by <code>reloadTimeInSeconds</code>.  Allows new services to be added on the fly.  Existing services are updated, and obsolete services are removed.</p>
<h3 id="reaping-completed-status">Reaping Completed Status</h3>
<p>Services that are running or completed hold their status in memory.  By default, completed jobs (success or fail) are reaped every hour.  This may be controled by the <code>reapTimeInSeconds</code> in the <code>sergeant.yml</code> file.</p>
<h2 id="rest">REST</h2>
<p>Each service creates some REST APIs.  <code>sleep</code> is the service used in this example.</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>URL</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/rest/service</td>
<td>JSON description of all services</td>
</tr>
<tr>
<td>GET</td>
<td>/rest/job</td>
<td>JSON description of all jobs running and compteled that have not been reaped.</td>
</tr>
<tr>
<td>GET</td>
<td>/rest/service/sleep</td>
<td>Returns the definition of the service</td>
</tr>
<tr>
<td>POST</td>
<td>/rest/service/sleep</td>
<td>Starts executing the service.  If synchronous, blocks until the service completes.  If asynchronous, returns a <code>uuid</code> that is used to lookup the status of the job.</td>
</tr>
<tr>
<td>GET</td>
<td>/rest/job/<code>uuid</code></td>
<td>Returns job status.</td>
</tr>
<tr>
<td>DELETE</td>
<td>/rest/job/<code>uuid</code></td>
<td>Deletes the job, killing if still running.</td>
</tr>
</tbody>
</table>
<h2 id="examples">Examples</h2>
<h3 id="sleep-example">Sleep Example</h3>
<p>Definition of the sleep service in <code>sergeant.yml</code>.</p>
<pre class="editor-colors"><code class="lang-yml"><div><span class="source yaml"><span class="string unquoted yaml"><span class="entity name tag yaml">workers<span class="punctuation separator key-value yaml">:</span></span></span></span></div><div><span class="source yaml">  <span class="string unquoted yaml"><span class="punctuation definition entry yaml">- </span><span class="entity name tag yaml">endPoint<span class="punctuation separator key-value yaml">:</span></span> <span class="string unquoted yaml">sleep</span></span></span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">commandLine<span class="punctuation separator key-value yaml">:</span></span><span class="string unquoted yaml"> </span></span>[<span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>sleep<span class="punctuation definition string end yaml">"</span></span>, <span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>@seconds<span class="punctuation definition string end yaml">"</span></span>]</span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">description<span class="punctuation separator key-value yaml">:</span></span> <span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>Powernap<span class="punctuation definition string end yaml">"</span></span></span></span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">defaults<span class="punctuation separator key-value yaml">:</span></span></span></span></div><div><span class="source yaml">      <span class="constant numeric yaml"><span class="entity name tag yaml">seconds<span class="punctuation separator key-value yaml">:</span></span> 120</span></span></div></code></pre>
<p>Invoking the sleep service.  NB: <code>curl</code> converts a <code>POST</code> command into a <code>GET</code>, if no parameters are passed using the <code>-d</code> flag.  The best workaround is to pass some dummy value.  Sergeant ignores any unknown substitutions.</p>
<pre class="editor-colors"><code class="lang-json"><div><span class="source json">curl -POST -d seconds=<span class="constant numeric json">120</span> http://localhost:<span class="constant numeric json">8080</span>/rest/service/sleep</span></div><div><span class="source json">  <span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json">{</span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>uuid<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span>519898b5-5afb-413d-bfc3-a2ff3a94afbd<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>commandLine<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span>sleep 120<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>exitValue<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="constant numeric json">-1</span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>status<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span>running<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>output<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span><span class="punctuation definition string end json">"</span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json">  </span><span class="punctuation definition dictionary end json">}</span></span></span></div></code></pre>
<p>The response to the post includes the job <code>uuid</code> used to look up status, the <code>commandLine</code> called, <code>exitValue</code> (-1 until the status is done), <code>status</code> of the job, and <code>output</code> of the job, when completed.</p>
<p>Status can be fetched using the <code>uuid</code>:</p>
<pre class="editor-colors"><code class="lang-json"><div><span class="source json">curl http://localhost:<span class="constant numeric json">8080</span>/rest/job/<span class="constant numeric json">519898</span>b<span class="constant numeric json">5-5</span>afb<span class="constant numeric json">-413</span>d-bfc<span class="constant numeric json">3</span>-a<span class="constant numeric json">2</span>ff<span class="constant numeric json">3</span>a<span class="constant numeric json">94</span>afbd</span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json">{</span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">  <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>uuid<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span>519898b5-5afb-413d-bfc3-a2ff3a94afbd<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">  <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>commandLine<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span>sleep 120<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">  <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>exitValue<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="constant numeric json">0</span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">  <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>status<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span>done<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">  <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>output<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span><span class="string quoted double json"><span class="punctuation definition string begin json">"</span><span class="punctuation definition string end json">"</span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary end json">}</span></span></span></div></code></pre>
<p>Status from all jobs can be fetched:</p>
<pre class="editor-colors"><code class="lang-json"><div><span class="source json">curl http://localhost:<span class="constant numeric json">8080</span>/rest/job</span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json">{</span></span></span></div><div><span class="source json"><span class="meta structure dictionary json">  <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>519898b5-5afb-413d-bfc3-a2ff3a94afbd<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span> <span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json">{</span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>uuid<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span> <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>519898b5-5afb-413d-bfc3-a2ff3a94afbd<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>commandLine<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span> <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>sleep 120<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>exitValue<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span> <span class="constant numeric json">0</span><span class="punctuation separator dictionary pair json">,</span></span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>status<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span> <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>done<span class="punctuation definition string end json">"</span></span><span class="punctuation separator dictionary pair json">,</span></span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json">    <span class="string quoted double json"><span class="punctuation definition string begin json">"</span>output<span class="punctuation definition string end json">"</span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json">:</span> <span class="string quoted double json"><span class="punctuation definition string begin json">"</span><span class="punctuation definition string end json">"</span></span></span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json">  </span><span class="punctuation definition dictionary end json">}</span></span></span></span></span></div><div><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary end json">}</span></span></span></div></code></pre>
<h4 id="example-sergeant-yml">Example sergeant.yml</h4>
<p>DropWizard describes several other <a href="http://dropwizard.github.io/dropwizard/manual/core.html">configuration options</a>, including logging.</p>
<pre class="editor-colors"><code class="lang-yml"><div><span class="source yaml"><span class="comment line number-sign yaml"><span class="punctuation definition comment yaml">#</span> Reap completed job status every hour</span></span></div><div><span class="source yaml"><span class="constant numeric yaml"><span class="entity name tag yaml">reapTimeInSeconds<span class="punctuation separator key-value yaml">:</span></span> 3600</span></span></div><div>&nbsp;</div><div><span class="source yaml"><span class="comment line number-sign yaml"><span class="punctuation definition comment yaml">#</span> Reload this config file every minute to pick up service changes</span></span></div><div><span class="source yaml"><span class="constant numeric yaml"><span class="entity name tag yaml">reloadTimeInSeconds<span class="punctuation separator key-value yaml">:</span></span> 60</span></span></div><div>&nbsp;</div><div><span class="source yaml"><span class="comment line number-sign yaml"><span class="punctuation definition comment yaml">#</span> Services to expose</span></span></div><div><span class="source yaml"><span class="string unquoted yaml"><span class="entity name tag yaml">workers<span class="punctuation separator key-value yaml">:</span></span></span></span></div><div><span class="source yaml">  <span class="string unquoted yaml"><span class="punctuation definition entry yaml">- </span><span class="entity name tag yaml">endPoint<span class="punctuation separator key-value yaml">:</span></span> <span class="string unquoted yaml">sleep</span></span></span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">commandLine<span class="punctuation separator key-value yaml">:</span></span><span class="string unquoted yaml"> </span></span>[<span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>sleep<span class="punctuation definition string end yaml">"</span></span>, <span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>@seconds<span class="punctuation definition string end yaml">"</span></span>]</span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">description<span class="punctuation separator key-value yaml">:</span></span> <span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>Power nap time!<span class="punctuation definition string end yaml">"</span></span></span></span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">defaults<span class="punctuation separator key-value yaml">:</span></span></span></span></div><div><span class="source yaml">      <span class="constant numeric yaml"><span class="entity name tag yaml">seconds<span class="punctuation separator key-value yaml">:</span></span> 120</span></span></div><div>&nbsp;</div><div><span class="source yaml">  <span class="string unquoted yaml"><span class="punctuation definition entry yaml">- </span><span class="entity name tag yaml">endPoint<span class="punctuation separator key-value yaml">:</span></span> <span class="string unquoted yaml">echo</span></span></span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">commandLine<span class="punctuation separator key-value yaml">:</span></span><span class="string unquoted yaml"> </span></span>[<span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>echo<span class="punctuation definition string end yaml">"</span></span>, <span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>@text<span class="punctuation definition string end yaml">"</span></span>]</span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">description<span class="punctuation separator key-value yaml">:</span></span> <span class="string quoted double yaml"><span class="punctuation definition string begin yaml">"</span>Is there an echo in here?<span class="punctuation definition string end yaml">"</span></span></span></span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">synchronous<span class="punctuation separator key-value yaml">:</span></span> <span class="string unquoted yaml">true</span></span></span></div><div><span class="source yaml">    <span class="string unquoted yaml"><span class="entity name tag yaml">defaults<span class="punctuation separator key-value yaml">:</span></span></span></span></div><div><span class="source yaml">      <span class="string unquoted yaml"><span class="entity name tag yaml">text<span class="punctuation separator key-value yaml">:</span></span> <span class="string unquoted yaml">This space for rent</span></span></span></div></code></pre>
